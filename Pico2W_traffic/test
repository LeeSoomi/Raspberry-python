중앙에서 “지속 스캔 전용”으로 바로 확인

트리거 없이 계속 스캔만 하는 간단 스크립트를 하나 만듭니다.
/home/codestudio/COS/central_scan.py

#!/usr/bin/env python3
from bluepy.btle import Scanner
import time

def parse_service_data_hex(hexstr):
    try:
        b = bytes.fromhex(hexstr)
        if len(b) < 2: return None
        if b[0:2] != b'\xff\xff':  # UUID 0xFFFF
            return None
        payload = b[2:]
        if not payload: return None
        tag = payload[0]  # b'C' or b'P'
        if tag not in (0x43, 0x50):  # 'C', 'P'
            return None


------------------------------------


0) 어떤 hci가 살아있는지 확인
sudo btmgmt info
sudo btmgmt -i hci0 info
sudo btmgmt -i hci1 info


POWERED: yes, le(Low Energy) supported: yes면 OK.

1) 인터페이스 초기화(각각 실행)

아래 블록을 hci0, hci1에 각각 수행:

IF=hci0   # 또는 hci1
sudo btmgmt -i $IF power off
sudo btmgmt -i $IF le on
sudo btmgmt -i $IF bredr off
sudo btmgmt -i $IF connectable off
sudo btmgmt -i $IF power on

2) TX 테스트: 해당 hci로 “순수 광고” 내보내기 (raw HCI)
1) hci1에서 트리거 광고(이름 기반) 지속 송출

피코는 현재 “이름/축약이름” 파싱하므로 이 방식이 바로 먹힙니다.

# hci1 준비
sudo hciconfig hci1 up
sudo hcitool -i hci1 cmd 0x08 0x0006  a0 00  a0 00  03 00  00 00 00 00 00 00  07 00

# S:15|D:A|Q:1  (이름 광고)
sudo hcitool -i hci1 cmd 0x08 0x0008  \
  11  02 01 06  0D 09  53 3a 31 35 7c 44 3a 41 7c 51 3a 31  \
  00 00 00 00 00 00 00 00 00 00 00 00 00 00

# 광고 시작
sudo hcitool -i hci1 cmd 0x08 0x000a 01


멈출 때: sudo hcitool -i hci1 cmd 0x08 0x000a 00

(메시지 바꾸기 예시)

S:12|D:B|Q:1 로 바꾸려면 이름 부분만 교체하고 총 길이 바이트(맨 앞 0x11) 도 맞춰야 합니다. 필요하면 내가 계산해서 줄게요.

2) hci0에서 스캔으로 ACK(P) 관찰
sudo /home/codestudio/bleenv/bin/python /home/codestudio/COS/central_scan.py


기대 출력: P UID3=... 항목이 주기적으로 뜸
(지금 피코 TEST_FORCE_ACK=True라면 더 쉽게 P가 잡힙니다)

3) 결과에 따른 다음 단계

P가 보임 → 정상
→ 피코에서 TEST_FORCE_ACK=False로 돌리고 다시 확인
→ 필요하면 DEBUG_BEACON=False로 전환(운영 시 전파 혼잡↓)

P가 여전히 안 보임

hci1 광고가 폰 nRF Connect에서 이름 S:15|D:A|Q:1 로 보이는지 확인

(선택) 트리거를 Service Data(0xFFFE) 방식으로 바꾸기

sudo hcitool -i hci1 cmd 0x08 0x0008  \
  18  02 01 06  14 16 fe ff  53 3a 31 35 7c 44 3a 41 7c 51 3a 31  \
  00 00 00 00 00 00 00 00 00 00


→ 이 경우 피코 코드에 0xFFFE 파서 추가가 필요
여기서 C 는 “디버그 비콘”, P 는 “ACK” 입니다.
지금은 C만 떠도 정상. 이게 확인되면 이후 트리거-ACK 로직도 살아있다는 뜻입니다.

=========-------------------

라즈베리 다른 터미널에서 트리거 광고 켜기(hci1):

sudo hciconfig hci1 up
sudo hcitool -i hci1 cmd 0x08 0x0006  a0 00  a0 00  03 00  00 00 00 00 00 00  07 00
# 이름 "S:15|D:A|Q:1"
sudo hcitool -i hci1 cmd 0x08 0x0008  \
  11  02 01 06  0D 09  53 3a 31 35 7c 44 3a 41 7c 51 3a 31  \
  00 00 00 00 00 00 00 00 00 00 00 00 00 00
sudo hcitool -i hci1 cmd 0x08 0x000a 01
-------------
지금 돌리고 있는 central_scan.py(hci0) 화면에 ‘P 차량…’ 줄이 뜨는지 확인.
